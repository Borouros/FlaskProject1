<!DOCTYPE html>
<html lang="en">
<head>
  <title>Europe Map</title>
  <meta charset="UTF-8">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: "Merriweather", "Open Sans", sans-serif; padding-top: 30px; background: #fff; }
    .card { border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .card-header { background-color: #8B0016; color: white; font-weight: bold; }
    #map-card { height: 80vh; }
    #map { height: 100%; width: 100%; border-radius: 6px; }
    .country-label { font-weight: bold; color: #8B0016; font-size: 12px; text-shadow: 1px 1px 2px white; pointer-events: none; }
    .leaflet-popup-content input { width: 120px; margin-right: 5px; }
  </style>
</head>
<body>

<header class="container mb-4">
  <div class="d-flex align-items-center justify-content-between border-bottom pb-2">
    <img src="{{ url_for('static', filename='img/Education-in-Portugal_Logotype.jpg') }}" alt="Site Logo" class="logo" style="max-height:100px;">
    <h1 class="fs-3 text-end text-danger">
      <a href="https://www.theportugalnews.com/" class="custom-link">The Portugal News</a>
    </h1>
  </div>
</header>

<main class="container">
  <div class="card mb-5" id="map-card">
    <div class="card-header">Editable Europe Map</div>
    <div class="card-body p-0">
      <div id="map"></div>
    </div>
  </div>
</main>

<footer class="mt-5 text-center">
  <div class="container">
    <p>&copy; 2025 The Portugal News. All rights reserved.</p>
  </div>
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map;
let geoLayer;

// Europe bounds: [southWestLat, southWestLng], [northEastLat, northEastLng]
const europeBounds = [[34, -25], [72, 45]]; 

function initMap() {
  // Center map on Europe
  map = L.map('map', {
    center: [54, 15],
    zoom: 4,
    minZoom: 3,
    maxZoom: 7,
    maxBounds: europeBounds,
    maxBoundsViscosity: 1.0
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  loadCountries();
}

function getStoredNames() {
  return JSON.parse(localStorage.getItem('renamedCountries') || '{}');
}
function saveStoredNames(names) {
  localStorage.setItem('renamedCountries', JSON.stringify(names));
}

function loadCountries() {
  fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
    .then(res => res.json())
    .then(data => {
      const storedNames = getStoredNames();
      const europeanData = data.features.filter(f => f.properties.continent === 'Europe');

      geoLayer = L.geoJSON(europeanData, {
        style: {
          color: "#8B0016",
          weight: 1,
          fillColor: "#FFC107",
          fillOpacity: 0.6
        },
        onEachFeature: (feature, layer) => {
          const country = feature.properties.name;
          const displayName = storedNames[country] || country;

          // Show name permanently
          layer.bindTooltip(displayName, {
            permanent: true,
            direction: "center",
            className: "country-label"
          }).openTooltip();

          // Popup to rename
          layer.bindPopup(
            `<b>${displayName}</b><br>
            <input type="text" id="newName-${country}" placeholder="Rename...">
            <button onclick="rename('${country}')">Save</button>`
          );

          layer.countryName = country;
        }
      }).addTo(map);
    });
}

function rename(oldName) {
  const input = document.getElementById(`newName-${oldName}`);
  if (!input) return alert("Input not found");
  const newName = input.value.trim();
  if (!newName) return;

  const names = getStoredNames();
  names[oldName] = newName;
  saveStoredNames(names);

  geoLayer.eachLayer(layer => {
    if (layer.countryName === oldName) {
      layer.unbindTooltip();
      layer.bindTooltip(newName, {
        permanent: true,
        direction: "center",
        className: "country-label"
      }).openTooltip();
      layer.closePopup();
    }
  });
}

initMap();
</script>

</body>
</html>

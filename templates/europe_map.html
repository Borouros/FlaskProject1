<!DOCTYPE html>
<html lang="en">
<head>
  <title>Europe Map with Capitals</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }
    .country-label {
      font-weight: bold;
      color: #000;
      font-size: 13px;
      text-shadow: 1px 1px 2px white;
      pointer-events: none;
      text-align: center;
    }
    .leaflet-popup-content input { width: 120px; margin-right: 5px; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Capitals dictionary (expand as needed)
const capitals = {
  "Portugal": [38.7169, -9.139],
  "Spain": [40.4168, -3.7038],
  "France": [48.8566, 2.3522],
  "Germany": [52.52, 13.405],
  "Italy": [41.9028, 12.4964],
  "United Kingdom": [51.5074, -0.1278],
  "Czechia": [50.0755, 14.4378]
};

// LocalStorage helpers
function getStoredNames() {
    return JSON.parse(localStorage.getItem('renamedCountries') || '{}');
}
function saveStoredNames(names) {
    localStorage.setItem('renamedCountries', JSON.stringify(names));
}

// Random color generator
function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
    return color;
}

// Map setup
let map = L.map('map', {
    center: [54, 15],
    zoom: 4,
    minZoom: 3,
    maxZoom: 7,
    maxBounds: [[34, -25], [72, 45]],
    maxBoundsViscosity: 1.0
});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

fetch('https://raw.githubusercontent.com/leakyMirror/map-of-europe/master/GeoJSON/europe.geojson')
.then(res => res.json())
.then(data => {
    const storedNames = getStoredNames();
    const labelMarkers = {};

    L.geoJSON(data, {
        style: () => ({
            color: "#333",
            weight: 1,
            fillColor: getRandomColor(),
            fillOpacity: 0.7
        }),
        onEachFeature: (feature, layer) => {
            const originalName = feature.properties.name;
            const displayName = storedNames[originalName] || originalName;

            // Place label on capital or centroid
            let coords = capitals[originalName] || layer.getBounds().getCenter();
            const label = L.marker(coords, {
                icon: L.divIcon({
                    className: "country-label",
                    html: displayName,
                    iconSize: [100, 20]
                })
            }).addTo(map);
            labelMarkers[originalName] = label;

            // Popup for renaming
            layer.bindPopup(() => {
                const container = document.createElement('div');
                container.innerHTML = `
                    <b>${displayName}</b><br>
                    <input type="text" placeholder="Rename..." value="${displayName}">
                    <button>Save</button>
                `;

                const input = container.querySelector('input');
                const button = container.querySelector('button');

                button.addEventListener('click', () => {
                    const newName = input.value.trim();
                    if (!newName) return;

                    // Save in localStorage
                    storedNames[originalName] = newName;
                    saveStoredNames(storedNames);

                    // Update only this label immediately
                    label.setIcon(L.divIcon({
                        className: "country-label",
                        html: newName,
                        iconSize: [100, 20]
                    }));

                    layer.closePopup();
                });

                return container;
            });
        }
    }).addTo(map);
});
</script>
</body>
</html>

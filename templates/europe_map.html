<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Editable Europe Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .country-label {
      font-weight: bold;
      font-size: 13px;
      text-shadow: 1px 1px 2px white;
      pointer-events: auto;
      cursor: pointer;
      background: rgba(255,255,255,0.8);
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([54, 15], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const labelsLayer = L.layerGroup().addTo(map);
    const polygonLayer = L.layerGroup().addTo(map);

    const capitals = {
      "Albania": [41.3275,19.8189],
      "Andorra": [42.5078,1.5211],
      "Austria": [48.2082,16.3738],
      "Belarus": [53.9,27.5667],
      "Belgium": [50.8503,4.3517],
      "Bosnia and Herzegovina": [43.8563,18.4131],
      "Bulgaria": [42.6977,23.3219],
      "Croatia": [45.8150,15.9819],
      "Cyprus": [35.1856,33.3823],
      "Czechia": [50.0755,14.4378],
      "Denmark": [55.6761,12.5683],
      "Estonia": [59.4370,24.7536],
      "Finland": [60.1699,24.9384],
      "France": [48.8566,2.3522],
      "Germany": [52.5200,13.4050],
      "Greece": [37.9838,23.7275],
      "Hungary": [47.4979,19.0402],
      "Iceland": [64.1466,-21.9426],
      "Ireland": [53.3498,-6.2603],
      "Italy": [41.9028,12.4964],
      "Kosovo": [42.6629,21.1655],
      "Latvia": [56.9496,24.1052],
      "Liechtenstein": [47.1410,9.5215],
      "Lithuania": [54.6872,25.2797],
      "Luxembourg": [49.6116,6.1319],
      "Malta": [35.8989,14.5146],
      "Moldova": [47.0105,28.8638],
      "Monaco": [43.7384,7.4246],
      "Montenegro": [42.4304,19.2594],
      "Netherlands": [52.3676,4.9041],
      "North Macedonia": [41.9981,21.4254],
      "Norway": [59.9139,10.7522],
      "Poland": [52.2297,21.0122],
      "Portugal": [38.7169,-9.1390],
      "Romania": [44.4268,26.1025],
      "Russia": [55.7558,37.6173],
      "San Marino": [43.9356,12.4473],
      "Serbia": [44.8176,20.4569],
      "Slovakia": [48.1486,17.1077],
      "Slovenia": [46.0569,14.5058],
      "Spain": [40.4168,-3.7038],
      "Sweden": [59.3293,18.0686],
      "Switzerland": [46.9481,7.4474],
      "Turkey": [39.9208,32.8541],
      "Ukraine": [50.4500,30.5236],
      "United Kingdom": [51.5074,-0.1278],
      "Vatican": [41.9022,12.4539]
    };

    const STORAGE_KEY = "euRenamedCountries_v2";
    const getNames = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    const saveNames = (obj) => localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));

    function hashCode(str){
      let h = 0; for(let i=0;i<str.length;i++){ h = (h<<5) - h + str.charCodeAt(i); h|=0; } return Math.abs(h);
    }
    function colorFor(name){
      const h = hashCode(name) % 360;
      const s = 55 + (hashCode(name+'s') % 20);
      const l = 58 + (hashCode(name+'l') % 12);
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    const labelByKey = {};

    fetch('https://raw.githubusercontent.com/Borouros/europe-map-data/main/europe.geojson.txt')

      .then(r => r.json())
      .then(geo => {
        const stored = getNames();

        const geoLayer = L.geoJSON(geo, {
          style: feat => ({
            color: "#333",
            weight: 1,
            fillColor: colorFor(feat.properties.name),
            fillOpacity: 0.85
          }),
          onEachFeature: (feature, polygon) => {
            const country = feature.properties.name;
            const currentText = stored[country] ?? country;
            const pos = capitals[country] || polygon.getBounds().getCenter();

            const label = L.marker(pos, {
              icon: L.divIcon({
                className: "country-label",
                html: currentText,
                iconSize: [140, 24]
              })
            }).addTo(labelsLayer);

            label.on('click', () => renameKey(country, label, polygon));
            labelByKey[country] = label;

            polygon.bindPopup(() => {
              const wrap = document.createElement('div');
              wrap.innerHTML = `
                <div><strong>${country}</strong></div>
                <input type="text" value="${currentText}" />
                <button>Save</button>
              `;
              const input = wrap.querySelector('input');
              wrap.querySelector('button').addEventListener('click', () => {
                const newText = input.value.trim();
                if (!newText) return;
                stored[country] = newText;
                saveNames(stored);
                updateLabel(country, newText);
                polygon.closePopup();
              });
              return wrap;
            });
            polygon.on('click', () => polygon.openPopup());
          }
        });

        geoLayer.addTo(polygonLayer);
        map.fitBounds(geoLayer.getBounds());


        function updateLabel(key, text){
          const lbl = labelByKey[key];
          if (!lbl) return;
          lbl.setIcon(L.divIcon({
            className: "country-label",
            html: text,
            iconSize: [140,24]
          }));
        }

        function renameKey(key, marker, polygon){
          const storedNow = getNames();
          const current = storedNow[key] ?? key;
          const newText = prompt(`Rename "${key}"`, current);
          if (!newText) return;
          storedNow[key] = newText;
          saveNames(storedNow);
          updateLabel(key, newText);
          if (polygon && polygon.closePopup) polygon.closePopup();
        }
      })
      .catch(err => {
        alert("Failed to load country data. Please check your internet connection or try again later.");
        console.error(err);
      });
  </script>
</body>
</html>

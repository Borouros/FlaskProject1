<!DOCTYPE html>
<html lang="en">
<head>
  <title>Europe Map</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }
    .country-label {
      font-weight: bold;
      color: #000;
      font-size: 13px;
      text-shadow: 1px 1px 2px white;
      pointer-events: none;
    }
    .leaflet-popup-content input { width: 120px; margin-right: 5px; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

let map = L.map('map', {
    center: [54, 15],
    zoom: 4,
    minZoom: 3,
    maxZoom: 7,
    maxBounds: [[34, -25], [72, 45]],
    maxBoundsViscosity: 1.0
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function getStoredNames() {
    return JSON.parse(localStorage.getItem('renamedCountries') || '{}');
}
function saveStoredNames(names) {
    localStorage.setItem('renamedCountries', JSON.stringify(names));
}

function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
    return color;
}

function getCentroid(coords) {
    let area = 0, x = 0, y = 0;
    for (let i = 0; i < coords.length - 1; i++) {
        let xi = coords[i][0], yi = coords[i][1];
        let xi1 = coords[i+1][0], yi1 = coords[i+1][1];
        let cross = xi * yi1 - xi1 * yi;
        area += cross;
        x += (xi + xi1) * cross;
        y += (yi + yi1) * cross;
    }
    area *= 0.5;
    let factor = 1 / (6 * area);
    return [y * factor, x * factor];
}

fetch('https://raw.githubusercontent.com/leakyMirror/map-of-europe/master/GeoJSON/europe.geojson')
.then(res => res.json())
.then(data => {
    const storedNames = getStoredNames();
    const labelMarkers = {};

    data.features.forEach(f => {
        f.properties.fillColor = getRandomColor();
    });

    L.geoJSON(data, {
        style: feature => ({
            color: "#333",
            weight: 1,
            fillColor: feature.properties.fillColor,
            fillOpacity: 0.7
        }),
        onEachFeature: (feature, layer) => {
            const originalName = feature.properties.name;
            const displayName = storedNames[originalName] || originalName;

            let coords = feature.geometry.coordinates;
            let centroid;
            if (feature.geometry.type === "Polygon") {
                centroid = getCentroid(coords[0]);
            } else if (feature.geometry.type === "MultiPolygon") {
                centroid = getCentroid(coords[0][0]);
            }

            const label = L.marker(centroid, {
                icon: L.divIcon({
                    className: "country-label",
                    html: displayName,
                    iconSize: [100, 20]
                })
            }).addTo(map);
            labelMarkers[originalName] = label;

            layer.bindPopup(() => {
                const container = document.createElement('div');
                container.innerHTML = `<b>${displayName}</b><br>
                    <input type="text" placeholder="Rename..." id="input-${originalName}">
                    <button>Save</button>`;
                
                container.querySelector('button').addEventListener('click', () => {
                    const newName = container.querySelector('input').value.trim();
                    if (!newName) return;

                    storedNames[originalName] = newName;
                    saveStoredNames(storedNames);

                    label.setIcon(L.divIcon({
                        className: "country-label",
                        html: newName,
                        iconSize: [100, 20]
                    }));

                    layer.closePopup();
                });

                return container;
            });
        }
    }).addTo(map);
});
</script>
</body>
</html>
